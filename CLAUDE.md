# CLAUDE.md

## Package Manager

Use **pnpm** (not npm/yarn) for all commands: `pnpm install`, `pnpm run dev`, `pnpm run build`, etc.

## Plans

Save all design docs and implementation plans to `plans/` at the repo root. This directory is gitignored.

## Auto-Generated Files (Do NOT commit)

The following files are auto-generated and gitignored. Never `git add -f` them:

- `frontend/helpers/blog.json` — generated from blog markdown frontmatter
- `sitemap*.xml`, `robots.txt` — generated by Next.js build
- `next-env.d.ts`, `*.tsbuildinfo` — TypeScript build artifacts

## Tech Stack

**Frontend:** Next.js ^14.1.0 (Pages Router, static export) · React ^18.2.0 · TypeScript ^4.9.5 · Tailwind CSS ^3.4.0 · D3.js (axis, scale, selection, shape) · Axios ^1.8.2 · FontAwesome ^6.4.2 · Lodash ^4.17.21 · Dayjs ^1.11.10 · Gray-matter ^4.0.3 · Marked ^9.1.6

**Backend:** Koa.js · TypeScript · D3.js (server-side SVG) · JSDOM · SVGO · Satori + @resvg/resvg-js (OG card images) · LRU cache

## Project Structure

The repo has three main directories: `frontend/`, `backend/`, and `arena/`.

### Frontend

All frontend code lives under `frontend/`.

| Directory | Purpose |
|-----------|---------|
| `pages/` | Next.js page routes (Pages Router) |
| `components/` | React UI components |
| `store/` | React Context state management with URL hash sync |
| `shared/common/` | GitHub API client (`api.tsx`), chart data logic (`chart.tsx`), utilities |
| `shared/packages/` | D3 chart implementation (`xy-chart.tsx`) and chart components |
| `shared/types/` | TypeScript type definitions |
| `helpers/` | Utilities (storage, toast, formatting, constants) and static data JSON |
| `styles/` | Tailwind config, global CSS, fonts (Inter font family) |
| `server/` | LRU cache for repo star data |
| `scripts/` | Blog JSON generation script |
| `public/` | Static assets and blog images |
| `plugins/` | Build scripts and utilities |

## Routes

Next.js **Pages Router** with `output: "export"` (static site generation).

| Route | File (`frontend/pages/`) | Description |
|-------|--------------------------|-------------|
| `/` | `index.tsx` | Home — chart viewer with repo input, sidebars |
| `/blog` | `blog/index.tsx` | Blog listing page |
| `/blog/[slug]` | `blog/[slug].tsx` | Individual blog post (markdown-based) |
| `/:owner/:repo` | `[...slug].tsx` | Repository detail page (catch-all) |
| 404 | `404.tsx` | Custom 404 with context-aware messages |

Layout wrappers: `_app.tsx` (per-page `getLayout` pattern), `_document.tsx`.

## State & Data Flow

1. **URL hash** (`#repo1&repo2&type=date&logscale`) → parsed in `store/index.tsx`
2. `RepoInputer` manages repo list → triggers `StarChartViewer`
3. `shared/common/api.tsx` fetches star history from GitHub API (with pagination & token auth)
4. `shared/common/chart.tsx` transforms data to D3-compatible format
5. `shared/packages/xy-chart.tsx` renders the SVG chart via D3

## Key Files for Common Changes

- **Chart rendering**: `shared/packages/xy-chart.tsx`, `components/StarChartViewer.tsx`, `components/Charts/StarXYChart.tsx`
- **GitHub API**: `shared/common/api.tsx`
- **State management**: `store/index.tsx`
- **Repo detail page**: `pages/[...slug].tsx`, `components/PageShell.tsx`
- **Blog system**: `pages/blog/[slug].tsx`, `scripts/generateBlogJson.mts`
- **Layout & nav**: `components/header.tsx`, `components/footer.tsx`, `components/LeftSidebar.tsx`, `components/RightSidebar.tsx`
- **Styling**: `tailwind.config.js`, `global.css`

## Backend (API Server)

The `backend/` directory is a Koa.js server (deployed as `api.star-history.com`) that generates star history SVG charts and OG card images.

- **Dev**: `cd backend && pnpm dev`
- **Build**: `cd backend && pnpm build`
- Requires `token.env` with GitHub tokens (one per line)

| File | Purpose |
|------|---------|
| `main.ts` | Koa server with `/svg` endpoint (query params: `repos`, `type`, `style`, `size`, `theme`) |
| `og-card.ts` | Satori-based OG card image renderer (`style=card` → 1200×630 PNG) |
| `cache.ts` | LRU cache (10K repos, 1GB, 24h TTL) for star records |
| `token.ts` | GitHub token rotation |
| `utils.ts` | SVG manipulation, image conversion helpers |
| `shared/` | Code shared with frontend (API client, chart data, D3 chart, types) |
| `assets/` | Fonts (xkcd.ttf, Inter.ttf) and logo for OG card rendering |

## Arena (Data Pipeline)

The `arena/` directory contains the data pipeline that fetches repo stats and exports JSON files consumed by the frontend.

- **Full run**: `cd arena && pnpm run fetch` — fetches from GitHub API + BigQuery, writes to SQLite (`data.db`), and exports JSON files
- **Re-export only**: `cd arena && pnpm run export` — re-exports JSON files from existing `data.db` without fetching (useful after code changes)
- **DB is ephemeral**: `createDatabase()` drops all tables and recreates them on every run. The SQLite DB can always be regenerated from source APIs.
- **Exported JSON files** (written to `frontend/helpers/`): `leaderboard.json`, `weekly-ranking.json`, `repos.json`, `repo-cards.json`

| File | Purpose |
|------|---------|
| `fetch.ts` | Main entry point — orchestrates the full pipeline |
| `github.ts` | GitHub API client to find qualifying repos |
| `bigquery.ts` | BigQuery client to fetch weekly activity stats |
| `db.ts` | SQLite schema, inserts, and JSON export functions |
| `types.ts` | Shared TypeScript types |